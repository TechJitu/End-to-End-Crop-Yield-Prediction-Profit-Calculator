import React, { useState } from 'react';
import { Sprout, CloudRain, MapPin, Calendar, TrendingUp, DollarSign, AlertCircle, Settings, CheckCircle2 } from 'lucide-react';

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-lg border border-gray-100 p-6 ${className}`}>
    {children}
  </div>
);

const InputGroup = ({ label, icon: Icon, children }) => (
  <div className="space-y-1">
    <label className="flex items-center gap-2 text-sm font-medium text-gray-700">
      <Icon size={16} className="text-green-600" />
      {label}
    </label>
    {children}
  </div>
);

export default function App() {
  const [formData, setFormData] = useState({
    Crop: 'Rice',
    Season: 'Kharif',
    State: 'Odisha', // Defaulting to a state likely in dataset
    Crop_Year: 2024,
    Area: 1000,
    Annual_Rainfall: 1500,
    Fertilizer: 5000,
    Pesticide: 200,
  });

  const [economics, setEconomics] = useState({
    sellingPricePerTon: 25000,
    cultivationCostPerHectare: 15000
  });

  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [error, setError] = useState(null);
  
  // Configuration for API
  const [useSimulation, setUseSimulation] = useState(true);
  const [apiUrl, setApiUrl] = useState('https://your-app-name.onrender.com');

  const crops = ['Rice', 'Maize', 'Chickpea', 'Kidneybeans', 'Pigeonpeas', 'Mothbeans', 'Mungbean', 'Blackgram', 'Lentil', 'Pomegranate', 'Banana', 'Mango', 'Grapes', 'Watermelon', 'Muskmelon', 'Apple', 'Orange', 'Papaya', 'Coconut', 'Cotton', 'Jute', 'Coffee'];
  const seasons = ['Kharif', 'Rabi', 'Whole Year', 'Summer', 'Winter', 'Autumn'];
  
  // Note: ideally fetch these from backend, but hardcoding common ones for UI speed
  const states = ['Andhra Pradesh', 'Arunachal Pradesh', 'Assam', 'Bihar', 'Chhattisgarh', 'Goa', 'Gujarat', 'Haryana', 'Himachal Pradesh', 'Jammu and Kashmir ', 'Jharkhand', 'Karnataka', 'Kerala', 'Madhya Pradesh', 'Maharashtra', 'Manipur', 'Meghalaya', 'Mizoram', 'Nagaland', 'Odisha', 'Punjab', 'Rajasthan', 'Sikkim', 'Tamil Nadu', 'Telangana ', 'Tripura', 'Uttar Pradesh', 'Uttarakhand', 'West Bengal'];

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: ['Crop_Year', 'Area', 'Annual_Rainfall', 'Fertilizer', 'Pesticide'].includes(name) 
        ? parseFloat(value) || 0 
        : value
    }));
  };

  const handleEconChange = (e) => {
    const { name, value } = e.target;
    setEconomics(prev => ({ ...prev, [name]: parseFloat(value) || 0 }));
  };

  const calculateProfit = (predictedYield) => {
    // Logic: 
    // Total Revenue = Yield (tons) * Price (per ton)
    // Total Cost = Area (hectares) * Cost (per hectare)
    // Note: The model predicts "Yield", typically in Tons/Hectare or Total Tons depending on training.
    // Based on README, it predicts "Yield". Let's assume the model predicts "Yield per Hectare" (common) 
    // OR "Total Production". 
    // Looking at the CSV snippet, "Yield" seems to be Production/Area.
    // So Predicted Value = Tons per Hectare.
    
    const yieldPerHectare = predictedYield; 
    const totalProduction = yieldPerHectare * formData.Area; // Total Tons
    
    const totalRevenue = totalProduction * economics.sellingPricePerTon;
    const totalCost = formData.Area * economics.cultivationCostPerHectare;
    const netProfit = totalRevenue - totalCost;
    
    return {
      totalProduction,
      totalRevenue,
      totalCost,
      netProfit,
      roi: totalCost > 0 ? ((netProfit / totalCost) * 100).toFixed(1) : 0
    };
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    setError(null);
    setResult(null);

    try {
      let predictedValue;

      if (useSimulation) {
        // SIMULATION MODE (For demonstration without backend)
        await new Promise(resolve => setTimeout(resolve, 1500));
        // Simple heuristic for fake prediction
        predictedValue = 2.5 + (Math.random() * 2); 
      } else {
        // PRODUCTION MODE
        const response = await fetch(`${apiUrl}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        if (!response.ok) {
          throw new Error('Failed to fetch prediction from server');
        }

        const data = await response.json();
        predictedValue = data.predicted_yield;
      }

      const financialData = calculateProfit(predictedValue);
      setResult({ yield: predictedValue, ...financialData });

    } catch (err) {
      setError(err.message || "An unexpected error occurred");
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-green-50 to-emerald-100 p-4 md:p-8 font-sans text-gray-800">
      <div className="max-w-6xl mx-auto space-y-8">
        
        {/* Header */}
        <header className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border-b-4 border-green-500">
          <div className="flex items-center gap-4">
            <div className="bg-green-100 p-3 rounded-full">
              <Sprout className="w-8 h-8 text-green-600" />
            </div>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">Agri-Yield Forecaster</h1>
              <p className="text-gray-500 text-sm">AI-Powered Crop Production & Profit Analysis</p>
            </div>
          </div>
          
          <div className="mt-4 md:mt-0 flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg border border-gray-200">
            <Settings size={16} className="text-gray-400" />
            <div className="flex items-center gap-2 text-sm">
              <span className={`cursor-pointer ${useSimulation ? 'font-bold text-blue-600' : 'text-gray-400'}`} onClick={() => setUseSimulation(true)}>Simulation</span>
              <div 
                className={`w-10 h-5 bg-gray-300 rounded-full relative cursor-pointer transition-colors ${!useSimulation ? 'bg-green-500' : ''}`}
                onClick={() => setUseSimulation(!useSimulation)}
              >
                <div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${!useSimulation ? 'translate-x-5' : ''}`} />
              </div>
              <span className={`cursor-pointer ${!useSimulation ? 'font-bold text-green-600' : 'text-gray-400'}`} onClick={() => setUseSimulation(false)}>Live API</span>
            </div>
          </div>
        </header>

        {/* Configuration Warning (Only if live) */}
        {!useSimulation && (
          <div className="bg-amber-50 border border-amber-200 p-4 rounded-lg flex gap-3 items-start animate-in fade-in slide-in-from-top-2">
            <AlertCircle className="text-amber-600 mt-1 shrink-0" size={20} />
            <div className="flex-1">
              <h3 className="font-semibold text-amber-800">Live API Configuration</h3>
              <p className="text-sm text-amber-700 mb-2">
                To use the Live API, you must deploy the Python backend provided in the file list and paste the URL below.
              </p>
              <input 
                type="text" 
                value={apiUrl}
                onChange={(e) => setApiUrl(e.target.value)}
                placeholder="https://your-api-url.onrender.com"
                className="w-full p-2 text-sm border border-amber-300 rounded focus:ring-2 focus:ring-amber-500 outline-none"
              />
            </div>
          </div>
        )}

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          
          {/* LEFT COLUMN: Inputs */}
          <div className="lg:col-span-2 space-y-6">
            <form onSubmit={handleSubmit}>
              <Card>
                <h2 className="text-lg font-semibold mb-6 flex items-center gap-2 border-b pb-2">
                  <MapPin size={20} className="text-green-600" />
                  Farm Parameters
                </h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <InputGroup label="Select Crop" icon={Sprout}>
                    <select 
                      name="Crop" 
                      value={formData.Crop} 
                      onChange={handleInputChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    >
                      {crops.map(c => <option key={c} value={c}>{c}</option>)}
                    </select>
                  </InputGroup>

                  <InputGroup label="Season" icon={Calendar}>
                    <select 
                      name="Season" 
                      value={formData.Season} 
                      onChange={handleInputChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    >
                      {seasons.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </InputGroup>

                  <InputGroup label="State" icon={MapPin}>
                    <select 
                      name="State" 
                      value={formData.State} 
                      onChange={handleInputChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    >
                      {states.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>
                  </InputGroup>

                  <InputGroup label="Crop Year" icon={Calendar}>
                    <input 
                      type="number" 
                      name="Crop_Year" 
                      value={formData.Crop_Year} 
                      onChange={handleInputChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    />
                  </InputGroup>

                  <InputGroup label="Farm Area (Hectares)" icon={MapPin}>
                    <input 
                      type="number" 
                      name="Area" 
                      value={formData.Area} 
                      onChange={handleInputChange}
                      step="0.1"
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    />
                  </InputGroup>

                  <InputGroup label="Annual Rainfall (mm)" icon={CloudRain}>
                    <input 
                      type="number" 
                      name="Annual_Rainfall" 
                      value={formData.Annual_Rainfall} 
                      onChange={handleInputChange}
                      step="0.1"
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    />
                  </InputGroup>

                   <InputGroup label="Fertilizer Usage (kg)" icon={Sprout}>
                    <input 
                      type="number" 
                      name="Fertilizer" 
                      value={formData.Fertilizer} 
                      onChange={handleInputChange}
                      step="0.1"
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    />
                  </InputGroup>

                  <InputGroup label="Pesticide Usage (kg)" icon={AlertCircle}>
                    <input 
                      type="number" 
                      name="Pesticide" 
                      value={formData.Pesticide} 
                      onChange={handleInputChange}
                      step="0.1"
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 outline-none transition-all"
                    />
                  </InputGroup>
                </div>
              </Card>

              <Card className="mt-6">
                <h2 className="text-lg font-semibold mb-6 flex items-center gap-2 border-b pb-2">
                  <DollarSign size={20} className="text-blue-600" />
                  Economics (For Profit Calculation)
                </h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <InputGroup label="Est. Selling Price (₹/Ton)" icon={DollarSign}>
                    <input 
                      type="number" 
                      name="sellingPricePerTon" 
                      value={economics.sellingPricePerTon} 
                      onChange={handleEconChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                    />
                  </InputGroup>
                  <InputGroup label="Cultivation Cost (₹/Hectare)" icon={DollarSign}>
                    <input 
                      type="number" 
                      name="cultivationCostPerHectare" 
                      value={economics.cultivationCostPerHectare} 
                      onChange={handleEconChange}
                      className="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
                    />
                  </InputGroup>
                </div>
              </Card>

              <button 
                type="submit" 
                disabled={loading}
                className={`mt-6 w-full py-4 rounded-xl text-white font-bold text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1 ${loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500'}`}
              >
                {loading ? 'Analyzing Soil & Climate Data...' : 'Predict Yield & Calculate Profit'}
              </button>
            </form>
          </div>

          {/* RIGHT COLUMN: Results */}
          <div className="lg:col-span-1 space-y-6">
            {error && (
              <div className="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200 flex items-start gap-3">
                <AlertCircle className="shrink-0 mt-0.5" />
                <p>{error}</p>
              </div>
            )}

            {result && !loading && (
              <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 space-y-6">
                {/* Main Prediction */}
                <Card className="bg-gradient-to-br from-green-600 to-emerald-800 text-white border-none">
                  <h3 className="text-green-100 text-sm font-medium mb-1">Predicted Yield</h3>
                  <div className="text-4xl font-bold mb-2">
                    {result.yield.toFixed(2)} <span className="text-xl font-normal text-green-200">tons/ha</span>
                  </div>
                  <div className="flex items-center gap-2 text-green-100 text-sm bg-white/10 p-2 rounded-lg">
                    <CheckCircle2 size={16} />
                    High confidence prediction
                  </div>
                </Card>

                {/* Financial Breakdown */}
                <Card>
                  <h3 className="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                    <TrendingUp className="text-blue-600" />
                    Financial Projection
                  </h3>
                  
                  <div className="space-y-4">
                    <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                      <span className="text-gray-600 text-sm">Total Production</span>
                      <span className="font-bold text-gray-900">{result.totalProduction.toFixed(1)} Tons</span>
                    </div>

                    <div className="flex justify-between items-center p-3 bg-blue-50 rounded-lg text-blue-900">
                      <span className="text-sm">Expected Revenue</span>
                      <span className="font-bold">₹{result.totalRevenue.toLocaleString()}</span>
                    </div>

                     <div className="flex justify-between items-center p-3 bg-red-50 rounded-lg text-red-900">
                      <span className="text-sm">Total Cost</span>
                      <span className="font-bold">₹{result.totalCost.toLocaleString()}</span>
                    </div>

                    <div className="border-t border-gray-100 my-2 pt-2">
                      <div className="flex justify-between items-center">
                        <span className="font-bold text-gray-700">Net Profit</span>
                        <span className={`text-xl font-bold ${result.netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                          {result.netProfit >= 0 ? '+' : ''}₹{result.netProfit.toLocaleString()}
                        </span>
                      </div>
                      <div className="text-right text-sm text-gray-400 mt-1">
                        ROI: {result.roi}%
                      </div>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {!result && !loading && !error && (
              <div className="h-64 flex flex-col items-center justify-center text-gray-400 bg-white/50 rounded-xl border-2 border-dashed border-gray-200">
                <Sprout size={48} className="mb-2 opacity-20" />
                <p>Enter data to view predictions</p>
              </div>
            )}
          </div>

        </div>
      </div>
    </div>
  );
}
